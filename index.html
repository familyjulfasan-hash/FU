<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan4Teams — Scanner QR numérique pour 4 équipes</title>
  <style>
    :root{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
    body{max-width:900px;margin:24px auto;padding:18px;background:#f7f8fa;border-radius:12px}
    h1{font-size:1.3rem;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:#333}
    .teams{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .team{flex:1 1 45%;background:white;padding:10px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    .team h3{margin:0 0 6px;font-size:1rem}
    .team .code{font-weight:700;font-size:1.05rem;color:#0b5ed7}
    #scannerContainer{background:#111;padding:10px;border-radius:10px;min-height:220px;display:flex;align-items:center;justify-content:center;color:white}
    .controls{display:flex;gap:8px;margin:12px 0}
    button{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:white;cursor:pointer}
    button.primary{background:#0b5ed7;color:white;border:none}
    .results{margin-top:12px}
    .match{background:#e6f4ea;padding:8px;border-radius:8px;margin-bottom:8px}
    .warn{background:#fff3cd;padding:8px;border-radius:8px}
    small.note{color:#666}
    input[type=text]{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
  </style>
</head>
<body>
  <h1>Scan4Teams</h1>
  <p class="lead">Application simple (fichier unique) pour que 4 équipes scannent l'une après l'autre un QR code numérique. L'app affiche ensuite quelles équipes ont le même code.</p>

  <div class="teams" id="teamsList"></div>

  <div id="scannerSection">
    <h2 style="font-size:1rem;margin-top:8px">Scanner (équipe <span id="currentTeamLabel">—</span>)</h2>
    <div id="scannerContainer">
      <div id="reader" style="width:100%"></div>
      <div id="placeholder" style="text-align:center;color:#ddd">Appuyez sur "Démarrer le scan" pour ouvrir la caméra</div>
    </div>

    <div class="controls">
      <button id="startBtn" class="primary">Démarrer le scan</button>
      <button id="stopBtn">Arrêter</button>
      <button id="nextBtn">Passer à l'équipe suivante</button>
      <button id="resetBtn">Réinitialiser</button>
    </div>

    <div style="margin-top:8px">
      <label><small>Ou saisir manuellement le code numérique pour l'équipe courante :</small></label>
      <div style="display:flex;gap:8px;margin-top:6px"><input id="manualInput" type="text" placeholder="Ex. 123456" /><button id="applyManual">Enregistrer</button></div>
    </div>

    <div class="results" id="resultArea"></div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>
    // Config
    const TEAMS = ["Équipe A","Équipe B","Équipe C","Équipe D"]; // change si besoin

    // Etat en mémoire (pas de BD)
    const state = {
      codes: Array(4).fill(null), // valeurs scannées (string)
      current: 0,
      scanner: null,
      isScanning: false
    };

    // UI elements
    const teamsList = document.getElementById('teamsList');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextBtn = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');
    const currentTeamLabel = document.getElementById('currentTeamLabel');
    const resultArea = document.getElementById('resultArea');
    const manualInput = document.getElementById('manualInput');
    const applyManual = document.getElementById('applyManual');

    // Afficher la liste des équipes et leur code (si présent)
    function renderTeams(){
      teamsList.innerHTML = '';
      TEAMS.forEach((name, i)=>{
        const div = document.createElement('div'); div.className='team';
        const h = document.createElement('h3'); h.textContent = name + (i===state.current ? ' ←' : '');
        const p = document.createElement('div');
        p.innerHTML = state.codes[i] ? `<div class="code">${escapeHtml(state.codes[i])}</div><small class="note">(scanné)</small>` : `<small class="note">(pas encore scanné)</small>`;
        div.appendChild(h); div.appendChild(p); teamsList.appendChild(div);
      })
      currentTeamLabel.textContent = TEAMS[state.current];
    }

    function escapeHtml(unsafe){return unsafe.replace(/[&<>"']/g, function(m){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]});}

    // Calculer et montrer résultats
    function showResults(){
      resultArea.innerHTML = '';
      const mapping = {};
      state.codes.forEach((code, idx)=>{
        if(code==null) return;
        if(!mapping[code]) mapping[code]=[];
        mapping[code].push({team:TEAMS[idx], idx: idx+1});
      });

      const groups = Object.values(mapping).filter(g=>g.length>1);
      if(groups.length===0){
        resultArea.innerHTML = '<div class="warn">Aucune équipe ne partage le même code (ou il n\'y a pas encore assez de scans).</div>';
      } else {
        groups.forEach(g=>{
          const el = document.createElement('div'); el.className='match';
          const teamsText = g.map(x=>x.team + ` (Equipe ${x.idx})`).join(' — ');
          el.innerHTML = `<strong>Code partagé :</strong> ${escapeHtml(g[0].code || (state.codes[g[0].idx-1]))}<div style="margin-top:6px"><small>${teamsText}</small></div>`;
          resultArea.appendChild(el);
        })
      }

      // afficher les codes uniques (optionnel)
      const notScanned = state.codes.map((c,i)=>c?null:`${TEAMS[i]} (Equipe ${i+1})`).filter(Boolean);
      if(notScanned.length) resultArea.innerHTML += `<div class="warn" style="margin-top:8px">Pas encore scanné: ${notScanned.join(', ')}</div>`;
    }

    // Démarrer scanner pour l'équipe courante
    async function startScanner(){
      if(state.isScanning) return;
      const reader = document.getElementById('reader');
      // html5-qrcode
      state.scanner = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: {width: 250, height: 250} };
      try{
        await state.scanner.start({ facingMode: "environment" }, config, onScanSuccess);
        state.isScanning = true;
      } catch(err){
        alert('Impossible d\'accéder à la caméra: ' + err);
        state.scanner.clear(); state.scanner = null; state.isScanning=false;
      }
    }

    // Stop scanner
    async function stopScanner(){
      if(state.scanner){
        try{ await state.scanner.stop(); await state.scanner.clear(); }catch(e){}
        state.scanner = null; state.isScanning = false;
      }
      // remettre placeholder
      const reader = document.getElementById('reader');
      reader.innerHTML = '';
    }

    // Callback sur lecture QR
    function onScanSuccess(decodedText, decodedResult){
      // N'accepter que des codes numériques
      const numeric = decodedText.trim();
      if(/^\d+$/.test(numeric)){
        // enregistrer pour l'équipe courante
        state.codes[state.current] = numeric;
        stopScanner();
        renderTeams();
        showResults();
        // avancer automatiquement si possible
        if(state.current < TEAMS.length-1){ state.current++; renderTeams(); }
        else { alert('Tous les scans complétés (ou vous pouvez réinitialiser).'); }
      } else {
        // Ne pas enregistrer, mais informer
        alert('Code lu mais non numérique: "' + decodedText + '". Veuillez scanner un QR contenant uniquement des chiffres.');
      }
    }

    // Avancer manuellement
    function nextTeam(){
      if(state.current < TEAMS.length-1) state.current++;
      renderTeams();
    }

    // Appliquer saisie manuelle
    function applyManualForCurrent(){
      const v = manualInput.value.trim();
      if(!/^\d+$/.test(v)){ alert('Veuillez entrer uniquement des chiffres.'); return; }
      state.codes[state.current] = v;
      renderTeams(); showResults();
      if(state.current < TEAMS.length-1) state.current++;
      renderTeams();
      manualInput.value = '';
    }

    // Reset
    async function resetAll(){
      const ok = confirm('Réinitialiser tous les scans ?');
      if(!ok) return;
      await stopScanner();
      state.codes = Array(4).fill(null); state.current=0; renderTeams(); showResults();
    }

    // liés aux boutons
    startBtn.addEventListener('click', ()=>startScanner());
    stopBtn.addEventListener('click', ()=>stopScanner());
    nextBtn.addEventListener('click', ()=>nextTeam());
    resetBtn.addEventListener('click', ()=>resetAll());
    applyManual.addEventListener('click', ()=>applyManualForCurrent());

    // initialisation
    renderTeams(); showResults();

    // nettoyer à la fermeture de la page
    window.addEventListener('beforeunload', ()=>{ if(state.scanner) state.scanner.clear(); });
  </script>
</body>
</html>
